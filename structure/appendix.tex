\begin{appendices}

\chapter{Composer BNA: Model-File}
\label{append:model-file}
    
\begin{lstlisting}[frame=hl, caption={Composer BNA Model-File} ,backgroundcolor=\color{gray}]
namespace biz.innovationcenter.maintenance

participant Company identified by companyName {
o String companyName  
}

participant Machine identified by machineId {
o String machineId
o String type
o String model
--> Company owner
}

participant MaintenanceProvider identified by companyName {
o String companyName
o String experienceWith
}

asset MachineStatus identified by machineStatusId {
o String machineStatusId
o Boolean isBroken
--> Machine owner
}

asset MaintenanceContract identified by maintenanceContractId {
o String maintenanceContractId
o String maintenanceReason
o Boolean isAccepted
o Boolean isClosed
o String[] performedSteps
o String requiredLastStep optional
--> Machine owner
--> MaintenanceProvider maintenanceProvider optional
}

asset PaymentAgreement identified by paymentAgreementId {
o String paymentAgreementId
o Integer payment
o String maintenanceContractId
o Boolean isAccepted
}

transaction AcceptMaintenanceContract {
--> MaintenanceContract maintenanceContract
}

transaction InitMaintenance {
o Integer contractId
o String requiredLastStep optional
o String maintenanceReason optional
}

transaction CloseContract {
--> MaintenanceContract contract
}

transaction AddPerformedStep {
--> MaintenanceContract contract
o String performedStep
}

transaction AcceptPaymentAgreement {
--> PaymentAgreement paymentAgreement
}

transaction CreatePaymentAgreement {
o Integer paymentAgreementId
o Integer payment
o String maintenanceContractId
}

transaction SetupDemo {
}

event NewContractCreated {
}

event ContractClosed {
--> MaintenanceContract contract
--> MaintenanceProvider provider
}
\end{lstlisting}

\chapter{Composer BNA: JavaScript-File}
\label{append:javascript-file}

\begin{lstlisting}[frame=hl, caption={Composer BNA JavaScript File} ,backgroundcolor=\color{gray}]
'use strict';
/**
    * Write your transction processor functions here
    */

var NAMESPACE = 'biz.innovationcenter.maintenance';
var MACHINE_STATUS_SUFFIX = '_Status';
var MAINTENANCE_CONTRACT_SUFFIX = '_Contract';
var PAYMENT_AGREEMENT_PREFIX = 'Agreement_';

/**
    * Accept the MaintenanceContract
    * @param {biz.innovationcenter.maintenance.AcceptMaintenanceContract} tx The transaction instance.
    * @transaction
    */
function acceptMaintenanceContract(tx) {
    var error = null;

    //Check if the contract is already accepted
    if (tx.maintenanceContract.isAccepted === false) {
        //Check if the Participant has the required experience
        if (tx.maintenanceContract.owner.type === getCurrentParticipant().experienceWith) {
            //Set the new Contract Data
            tx.maintenanceContract.isAccepted = true;
            tx.maintenanceContract.maintenanceProvider = getCurrentParticipant();

            // Get the contract from the asset registry
            return getAssetRegistry('biz.innovationcenter.maintenance.MaintenanceContract')
                .then(function (assetRegistry) {
                    // Update the contract the asset registry.
                    return assetRegistry.update(tx.maintenanceContract);
                });
        } else {
            error = 'Error: Provider does not have required experience';
        }
    } else {
        error = 'Error: Contract is already accepted';
    }

    if (error !== null) {
        console.error(error);
        throw error;
    }
}

/**
    * Initiate the maintenance. Set status to broken and create a maintenance contract.  Can only be executed by machines(see ACL).
    * @param {biz.innovationcenter.maintenance.InitMaintenance} tx The transaction instance.
    * @transaction
    */
function initMaintenance(tx) {
    //TODO: Add condition
    var factory = getFactory();

    console.log('initMaintenance');
    var machineId = getCurrentParticipant().getIdentifier()
    var machineStatusId = machineId + MACHINE_STATUS_SUFFIX;
    console.log("CURRENT MACHINE STATUS ID: " + machineStatusId);

    //Initiate the MaintenanceContract
    var contractName = machineId + MAINTENANCE_CONTRACT_SUFFIX + "_" + tx.contractId;
    var contract = factory.newResource(NAMESPACE, 'MaintenanceContract', contractName);
    if (tx.maintenanceReason != undefined) {
        contract.maintenanceReason = tx.maintenanceReason;
    }
    else {
        contract.maintenanceReason = "Unknown";
    }

    if (tx.requiredLastStep != undefined) {
        contract.requiredLastStep = tx.requiredLastStep;
    }
    else {
        contract.requiredLastStep = "Unknown";
    }    
    contract.isAccepted = false;
    contract.isClosed = false;
    contract.performedSteps = [];
    
    contract.owner = factory.newRelationship(NAMESPACE, 'Machine', machineId);

    //Update the MachineStatus
    return getAssetRegistry(NAMESPACE + '.MachineStatus')
        .then(function (machineStatusRegistry) {
            return machineStatusRegistry.get(machineStatusId)
                .then(function (machineStatus) {
                    machineStatus.isBroken = true;
                    return machineStatusRegistry.update(machineStatus);
                })
        })
        //Add the contract to the registry
        .then(function () {
            return getAssetRegistry(NAMESPACE + '.MaintenanceContract')
                .then(function (contractRegistry) {
                    return contractRegistry.add(contract);
                })
                .then(function() {
                    //Emit event
                    var factory = getFactory();
                    var newContractEvent = factory.newEvent(NAMESPACE, 'NewContractCreated');
                    emit(newContractEvent);
                });
        });

}

/**
    * Add a performed maintenance step to the contract
    * @param {biz.innovationcenter.maintenance.AddPerformedStep} tx The transaction instance.
    * @transaction
    */
function addPerformedStep(tx) {
    //Update contract
    if (tx.contract.isAccepted == true) {
        if (tx.performedStep != "") {
            tx.contract.performedSteps.push(tx.performedStep);
            return getAssetRegistry(NAMESPACE + '.MaintenanceContract')
                .then(function (contractRegistry) {
                    return contractRegistry.update(tx.contract);
                });
        }

    } else {
        var error = 'Error: Contract is not accepted';
        console.error(error);
        throw error;
    }
}

/**
    * Close the given Contract
    * @param {biz.innovationcenter.maintenance.CloseContract} tx The transaction instance.
    * @transaction
    */
function closeContract(tx) {
    //Update contract
    if (tx.contract.isAccepted == true) {
        if (tx.contract.performedSteps.length != 0) {
            if (tx.contract.requiredLastStep == "Unknown" || tx.contract.requiredLastStep == tx.contract.performedSteps[tx.contract.performedSteps.length - 1]) {
                tx.contract.isClosed = true;
                return getAssetRegistry(NAMESPACE + '.MaintenanceContract')
                    .then(function (contractRegistry) {
                        return contractRegistry.update(tx.contract);
                    })
                    .then(function () {
                        console.log("Getting machine status registry");
                        return getAssetRegistry(NAMESPACE + '.MachineStatus')
                            .then(function (machineStatusRegistry) {
                                machineStatusRegistry.get(tx.contract.owner.getIdentifier() + MACHINE_STATUS_SUFFIX)
                                    .then(function (machineStatus) {
                                        //Update contract
                                        machineStatus.isBroken = false;
                                        return machineStatusRegistry.update(machineStatus);
                                    })
                                    .then(function() {
                                        //Emit event
                                        var factory = getFactory();
                                        var contractClosedEvent = factory.newEvent(NAMESPACE, 'ContractClosed');
                                        contractClosedEvent.contract = tx.contract;
                                        contractClosedEvent.provider = tx.contract.maintenanceProvider;
                                        emit(contractClosedEvent);
                                    });
                            });
                    });
            } else {
                var error = 'Error: Required last step was not performed';
                console.error(error);
                throw error;
            }
        } else {
            error = 'Error: No steps performed';
            console.error(error);
            throw error;
        }
    } else {
        error = 'Error: Contract is not accepted';
        console.error(error);
        throw error;
    }
}

/**
    * Add a performed maintenance step to the contract
    * @param {biz.innovationcenter.maintenance.CreatePaymentAgreement} tx The transaction instance.
    * @transaction
    */
function createPaymentAgreement(tx) {
    var factory = getFactory();
    var agreement = factory.newResource(NAMESPACE, 'PaymentAgreement', PAYMENT_AGREEMENT_PREFIX + tx.paymentAgreementId);    
    agreement.payment = tx.payment;
    agreement.maintenanceContractId = tx.maintenanceContractId;
    agreement.isAccepted = false;

    return getAssetRegistry(NAMESPACE + '.PaymentAgreement')
        .then(function (agreementRegistry) {
            return agreementRegistry.add(agreement);
        });
}

/**
    * Add a performed maintenance step to the contract
    * @param {biz.innovationcenter.maintenance.AcceptPaymentAgreement} tx The transaction instance.
    * @transaction
    */
function acceptPaymentAgreement(tx) {
    tx.paymentAgreement.isAccepted = true;

    return getAssetRegistry(NAMESPACE + '.PaymentAgreement')
        .then(function (agreementRegistry) {
            return agreementRegistry.update(tx.paymentAgreement);
        });
}

/**
    * Setup the demo
    * @param {biz.innovationcenter.maintenance.SetupDemo} setupDemo - the SetupDemo transaction
    * @transaction
    */
function setupDemo(setupDemo) {
    console.log('setupDemo');

    var factory = getFactory();

    //Declare the existing participants and assets
    var companyNames = ['Twimbee', 'Eiva'];
    var maintenanceProvNames = ['Repairr', 'Aintenance'];
    var machineNames = ['Elevator_1', 'Server_1'];
    var machineTypes = ['Elevator', 'Server'];
    var machineModels = ['EL213', 'SRV4'];

    //Create the resources and add them to arrays
    var companies = [];
    var maintenanceProviders = [];
    var machines = [];
    var machineStatuses = [];

    for (var i in companyNames) {
        var name = companyNames[i];
        var company = factory.newResource(NAMESPACE, 'Company', name);
        companies.push(company);
    }

    for (var i in maintenanceProvNames) {
        var name = maintenanceProvNames[i];
        var provider = factory.newResource(NAMESPACE, 'MaintenanceProvider', name);
        provider.experienceWith = machineTypes[i];
        maintenanceProviders.push(provider);
    }

    var i = 0;
    for (var i in machineNames) {
        var name = machineNames[i]
        var machine = factory.newResource(NAMESPACE, 'Machine', name);
        machine.type = machineTypes[i];
        machine.model = machineModels[i];
        machine.owner = factory.newRelationship(NAMESPACE, 'Company', companies[i].companyName)
        machines.push(machine);
        i++;
    }

    var i = 0;
    for (var i in machines) {
        var name = machineNames[i] + MACHINE_STATUS_SUFFIX;
        console.log("MACHINE NAME: " + name);
        var machineStatus = factory.newResource(NAMESPACE, 'MachineStatus', name);
        machineStatus.isBroken = false;
        machineStatus.owner = factory.newRelationship(NAMESPACE, 'Machine', machineNames[i]);
        machineStatuses.push(machineStatus);
        i++;
    }

    //Update the registries
    return getParticipantRegistry(NAMESPACE + '.Company')
        .then(function (companyRegistry) {
            return companyRegistry.addAll(companies);
        })
        .then(function () {
            return getParticipantRegistry(NAMESPACE + '.MaintenanceProvider');
        })
        .then(function (machineProvRegistry) {
            return machineProvRegistry.addAll(maintenanceProviders);
        })
        .then(function () {
            return getParticipantRegistry(NAMESPACE + '.Machine');
        })
        .then(function (machineRegistry) {
            return machineRegistry.addAll(machines);
        })
        .then(function () {
            return getAssetRegistry(NAMESPACE + '.MachineStatus');
        })
        .then(function (machineStatusRegistry) {
            return machineStatusRegistry.addAll(machineStatuses);
        });
}
\end{lstlisting}

\chapter{Composer BNA: ACL-Rules}
\label{append:acl-rules}

\begin{lstlisting}[frame=hl, caption={Composer BNA ACL-Rules} ,backgroundcolor=\color{gray}]
rule NetworkAdminUser {
    description: "Grant business network administrators full access to user resources"
    participant: "org.hyperledger.composer.system.NetworkAdmin"
    operation: ALL
    resource: "**"
    action: ALLOW
}

rule NetworkAdminSystem {
    description: "Grant business network administrators full access to system resources"
    participant: "org.hyperledger.composer.system.NetworkAdmin"
    operation: ALL
    resource: "org.hyperledger.composer.system.**"
    action: ALLOW
}

rule CompanyCanCreateMachineParticipants {
    description: "Allow companies to create machine-participants"
    participant(p): "biz.innovationcenter.maintenance.Company"
    operation: CREATE
    resource(m): "org.hyperledger.composer.system.Participant"
    condition: (p.getIdentifier() == m.owner.getIdentifier())
    action: ALLOW
}

rule CompanyCanDeleteMachineParticipants {
    description: "Allow companies to delete own machine-participants"
    participant(p): "biz.innovationcenter.maintenance.Company"
    operation: DELETE
    resource(m): "org.hyperledger.composer.system.Participant"
    condition: (p.getIdentifier() == m.owner.getIdentifier())
    action: ALLOW
}

rule MachineCanCreateStatusAsset {
    description: "Machine can create own Status-Asset"
    participant(p): "biz.innovationcenter.maintenance.Machine"
    operation: CREATE
    resource(m): "biz.innovationcenter.maintenance.MachineStatus"
    condition: ((p.getIdentifier() == m.owner.getIdentifier()) && (m.isBroken == false))
    action: ALLOW
}

rule MachineCanUpdateStatusAsset {
    description: "Machine can update own status-asset"
    participant: "biz.innovationcenter.maintenance.Machine"
    operation: UPDATE
    resource: "biz.innovationcenter.maintenance.MachineStatus"
    action: ALLOW
}

rule MachineCanCreateAndUpdateMaintenanceContract {
    description: "Machine can create and update MaintenanceContract-Asset"
    participant(p): "biz.innovationcenter.maintenance.Machine"
    operation: CREATE, UPDATE
    resource(m): "biz.innovationcenter.maintenance.MaintenanceContract"
    condition: (p.getIdentifier() == m.owner.getIdentifier())
    action: ALLOW
}

rule MaintenanceProviderCanUpdateMaintenanceContract {
    description: "Maintenance provider can update his accepted maintenanceContract"
    participant(p): "biz.innovationcenter.maintenance.MaintenanceProvider"
    operation: UPDATE
    resource(r): "biz.innovationcenter.maintenance.MaintenanceContract"
    condition: ((r.maintenanceProvider == null) || (r.maintenanceProvider.getIdentifier() == p.getIdentifier()))
    action: ALLOW
}

rule CompanyCanCreatePaymentAgreement {
    description: "Company can create PaymentAgreement"
    participant: "biz.innovationcenter.maintenance.Company"
    operation: CREATE
    resource: "biz.innovationcenter.maintenance.PaymentAgreement"
    action: ALLOW
}

rule MaintenanceProviderCanUpdatePaymentAgreement {
    description: "Maintenance provider can update PaymentAgreement"
    participant: "biz.innovationcenter.maintenance.MaintenanceProvider"
    operation: UPDATE
    resource: "biz.innovationcenter.maintenance.PaymentAgreement"
    action: ALLOW
}

rule MaintenanceProviderCanExecuteAcceptTransaction {
    description: "Maintenance provider can execute AcceptMaintenanceContract"
    participant(p): "biz.innovationcenter.maintenance.MaintenanceProvider"
    operation: CREATE
    resource(r): "biz.innovationcenter.maintenance.AcceptMaintenanceContract"
    condition: (r.maintenanceContract.maintenanceProvider == null)
    action: ALLOW
}

rule MachineCanExecuteCloseContractTransaction {
    description: "Maintenance provider can execute CloseContract"
    participant: "biz.innovationcenter.maintenance.Machine"
    operation: CREATE
    resource: "biz.innovationcenter.maintenance.CloseContract"
    action: ALLOW
}

rule MachineCanExecuteInitMaintenanceTransaction {
    description: "Machine can execute initMaintenance transaction"
    participant: "biz.innovationcenter.maintenance.Machine"
    operation: CREATE
    resource: "biz.innovationcenter.maintenance.InitMaintenance"
    action: ALLOW
}

rule ProviderCanExecuteAddPerformedStepTransaction {
    description: "Maintenance provider can add performed maintenance steps to his accepted contract"
    participant(p): "biz.innovationcenter.maintenance.MaintenanceProvider"
    operation: CREATE
    resource(r): "biz.innovationcenter.maintenance.AddPerformedStep"
    condition: (r.contract.maintenanceProvider.getIdentifier() == p.getIdentifier())
    action: ALLOW
}

rule CompanyCanExecuteCreatePaymentAgreementTransaction {
    description: "Company can execute CreatePaymentAgreementTransaction"
    participant: "biz.innovationcenter.maintenance.Company"
    operation: CREATE
    resource: "biz.innovationcenter.maintenance.CreatePaymentAgreement"
    action: ALLOW
}

rule ProviderCanExecuteAcceptPaymentAgreementTransaction {
    description: "Maintenance provider can execute AcceptPaymentAgreement"
    participant: "biz.innovationcenter.maintenance.MaintenanceProvider"
    operation: CREATE
    resource: "biz.innovationcenter.maintenance.AcceptPaymentAgreement"
    action: ALLOW
}

 rule denyParticipantEditing {
    description: "No participant is allowed to edit participants"
    participant: "ANY"
    operation: CREATE, UPDATE, DELETE
    resource: "org.hyperledger.composer.system.Participant"
    action: DENY
}

rule denyAssetEditingAndTransactionExecution {
    description: "No participant is allowed to edit assets or execute transactions"
    participant: "ANY"
    operation: CREATE, UPDATE, DELETE
    resource: "biz.innovationcenter.maintenance.*"
    action: DENY
}

rule EverybodyCanReadEverything {
    description: "Allow all participants read access to all resources"
    participant: "ANY"
    operation: READ
    resource: "biz.innovationcenter.maintenance.*"
    action: ALLOW
}


rule SystemACL {
  description:  "System ACL to permit all access"
  participant: "org.hyperledger.composer.system.Participant"
  operation: ALL
  resource: "org.hyperledger.composer.system.**"
  action: ALLOW
}
\end{lstlisting}


\end{appendices}

